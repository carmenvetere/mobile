
# Loads default set of integrations. Do not remove.
default_config:

my:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml
homekit: !include homekit.yaml
sensor: !include templates/sensors.yaml

device_tracker:
  - platform: group
    name: "Smartphones"
    entities:
      - device_tracker.brians_iphone_15_pro
      - device_tracker.carmens_iphone

input_datetime:
  last_pool_vacuum:
    name: Last Pool Vacuum
    has_date: true
    has_time: true

input_number:
  sonos_favorites_index:
    name: Sonos Favorites Index
    initial: 1
    min: 1
    max: 11
    step: 1
    mode: box
    
recorder:
  db_url: mysql://carmenv:Bayberry1991@core-mariadb/homeassistant?charset=utf8mb4
  purge_keep_days: 30
  exclude:
    domains:
      - media_player
    entity_globs:
      - sensor.time*
    entities:
      - sensor.date
      - sensor.time
      - sensor.last_boot
      - sun.sun 
      - sensor.powerwall_discharge_time
      - sensor.bayberry_tempest_wind_speed
      - sensor.bayberry_tempest_wind_direction

template:
  - sensor:
      - name: "Notification Alert Counter"
        unique_id: notification_alert_counter
        state: >
          {# ─── 1) Boolean rules (each evaluates to True/False) ─── #}
          {% set rules = [
            is_state('binary_sensor.bayberry_grid_status', 'off'),
            is_state('binary_sensor.dryer_recently_completed', 'on'),
            is_state('binary_sensor.washer_recently_completed', 'on'),
            (is_state('sensor.bayberry_tempest_precipitation_type','rain')
             and is_state('binary_sensor.pool_cover_pump','off')),
            is_state('cover.garage_door_garage','open'),
            is_state('input_boolean.low_pool_water_level','on'),
            is_state('sensor.tesla_wall_connector_status','error'),
            is_state('sensor.tesla_wall_connector_status','charging_reduced'),
            (states('sensor.roborock_s8_vacuum_error') not in ['none','unknown','unavailable']),
            (is_state('binary_sensor.bayberry_grid_status','off')
             and states('sensor.bayberry_charge')|float(100) < 25),
            states('sensor.nws_alerts_alerts')|int(0) > 0,
            states('sensor.front_load_washer_tub_clean_counter')|int(0) > 30,
            states('sensor.upper_floor_hvac_filter_time_2')|int(0) > 2000,
            states('sensor.lower_floors_hvac_filter_time_2')|int(0) > 2000,
            states('sensor.utility_room_temp_sensor_temperature')|float(99) < 55,
            states('sensor.utility_room_temp_sensor_temperature')|float(0)  > 80,
            states('sensor.attic_temp_sensor_temperature')|float(0)  > 80,
            states('sensor.attic_temp_sensor_temperature')|float(99) < 55,
            (states('sensor.hours_since_last_vacuum')|float(0) > 48
             and is_state('binary_sensor.pool_season','on')),
            states('sensor.omnilogic_pool_chlorinator_average_salt_level')|float(9999) < 2700,
            states('sensor.smithy_hot_water_availability_2')|float(9999)   < 20
          ] %}
          {# ─── 2) Battery list and count (< 20%) ─── #}
          {% set battery_sensors = expand(
            'sensor.bedroom_back_1_battery',
            'sensor.back_2_battery',
            'sensor.back_3_battery',
            'sensor.bedroom_back_4_battery_0',
            'sensor.bedroom_back_5_battery_0',
            'sensor.side_left_battery_2',
            'sensor.side_right_battery_0',
            'sensor.dining_room_front_left_battery_0',
            'sensor.front_left_battery',
            'sensor.front_right_battery_0',
            'sensor.bedroom_right_battery_0',
            'sensor.hallway_1_battery',
            'sensor.motionblind_ebae_battery',
            'sensor.bedroom_left_battery_0',
            'sensor.living_room_side_left_1_battery_0',
            'sensor.living_room_front_left_battery_0',
            'sensor.living_room_side_left_2_battery_0',
            'sensor.living_room_side_right_1_battery_0',
            'sensor.living_room_side_right_2_battery_0',
            'sensor.living_room_front_right_battery',
            'sensor.attic_temp_sensor_battery',
            'sensor.front_door_battery',
            'sensor.kitchen_french_doors_battery',
            'sensor.living_room_french_doors_battery',
            'sensor.mudroom_entry_battery',
            'sensor.mudroom_garage_battery',
            'sensor.utility_room_temp_sensor_battery',
            'sensor.back_guest_bedroom_side_battery',
            'sensor.back_guest_bedroom_back_left_battery',
            'sensor.back_guest_bedroom_back_right_battery'
          ) %}
          {% set low_batt = battery_sensors
             | map(attribute='state') | map('float', 100) | select('lt', 20) | list %}
          {% set low_batt_count = low_batt | count %}
          {# ─── 3) Final count: sum of booleans + count of low batteries ─── #}
          {{ (rules | map('int') | sum) + low_batt_count }}
        unit_of_measurement: "alerts"
        icon: mdi:alert-circle

template:
  - trigger:
      - trigger: event
        event_type: bubble_card_update_modules
    sensor:
      - name: "Bubble Card Modules"
        state: "saved"
        icon: "mdi:puzzle"
        attributes:
          modules: "{{ trigger.event.data.modules }}"
          last_updated: "{{ trigger.event.data.last_updated }}"

lovelace:
  mode: yaml
  dashboards:
    first-floor-dash:
      mode: yaml
      title: "First Floor - YAML"
      icon: mdi:floor-plan
      show_in_sidebar: false
      filename: first_floor_dash/first_floor.yaml
    mobile-dash:
      mode: yaml
      title: "Mobile - YAML"
      icon: mdi:cellphone
      show_in_sidebar: true
      filename: dashboards/mobile/mobile.yaml 
    mudroom-wall-panel-dash:
      mode: yaml
      title: Mudroom Wall Panel - YAML
      icon: mdi:alarm-panel
      show_in_sidebar: true
      filename: dashboards/wall-panel/mudroom-wall-panel.yaml
  resources: 
    - url: /hacsfiles/lovelace-layout-card/layout-card.js
      type: module
    - url: /hacsfiles/kiosk-mode/kiosk-mode.js
      type: module
    - url: /hacsfiles/Bubble-Card/bubble-card.js
      type: module
    - url: /hacsfiles/button-card/button-card.js
      type: module
    - url: /hacsfiles/power-flow-card-plus/power-flow-card-plus.js
      type: module
    - url: /hacsfiles/lovelace-mushroom/mushroom.js
      type: module
    - url: /hacsfiles/lovelace-card-mod/card-mod.js
      type: module
    - url: /browser_mod.js
      type: module      
    - url: /hacsfiles/lovelace-auto-entities/auto-entities.js
      type: module 
    - url: /hacsfiles/lovelace-expander-card/expander-card.js 
      type: module
    - url: /hacsfiles/stack-in-card/stack-in-card.js 
      type: module
    - url: /hacsfiles/llmvision-card/llmvision-card.js 
      type: module
    - url: /hacsfiles/ha-sankey-chart/ha-sankey-chart.js 
      type: module
    - url: /hacsfiles/mini-climate-card/mini-climate-card-bundle.js 
      type: module
    - url: /hacsfiles/vacuum-card/vacuum-card.js  
      type: module    
    - url: /hacsfiles/custom-sonos-card/custom-sonos-card.js
      type: module
    - url: /hacsfiles/simple-swipe-card/simple-swipe-card.js
      type: module
    - url: /hacsfiles/Ultra-Vehicle-Card/ultra-vehicle-card.js 
      type: module
    - url: /hacsfiles/lovelace-xiaomi-vacuum-map-card/xiaomi-vacuum-map-card.js 
      type: module
    - url: /hacsfiles/alarmo-card/alarmo-card.js 
      type: module
    - url: /hacsfiles/mediocre-hass-media-player-cards/mediocre-hass-media-player-cards.js 
      type: module  
      
homeassistant:
  media_dirs:
    llmvision: /config/media/llmvision

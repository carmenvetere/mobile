- sensor:
    - name: "Notification Alert Counter"
      unique_id: notification_alert_counter
      state: >
        {# ─── 1) Boolean rules (each evaluates to True/False) ─── #}
        {% set rules = [
          is_state('binary_sensor.bayberry_grid_status', 'off'),
          is_state('binary_sensor.dryer_recently_completed', 'on'),
          is_state('binary_sensor.washer_recently_completed', 'on'),
          (is_state('sensor.bayberry_tempest_precipitation_type','rain')
            and is_state('binary_sensor.pool_cover_pump','off')),
          is_state('cover.garage_door_garage','open'),
          is_state('input_boolean.low_pool_water_level','on'),
          (states('sensor.roborock_s8_vacuum_error') not in ['none','unknown','unavailable'] and states('sensor.roborock_s8_vacuum_error') != ''),
          (is_state('binary_sensor.bayberry_grid_status','off')
            and states('sensor.bayberry_charge')|float(100) < 25),
          (states('sensor.nws_alerts_alerts') not in ['unknown','unavailable'] and states('sensor.nws_alerts_alerts')|int(0) > 0),
          states('sensor.front_load_washer_tub_clean_counter')|int(0) > 30,
          states('sensor.upper_floor_hvac_filter_time_2')|int(0) > 2000,
          states('sensor.lower_floors_hvac_filter_time_2')|int(0) > 2000,
          states('sensor.utility_room_temp_sensor_temperature')|float(99) < 55,
          states('sensor.utility_room_temp_sensor_temperature')|float(0)  > 80,
          states('sensor.attic_temp_sensor_temperature')|float(0)  > 80,
          states('sensor.attic_temp_sensor_temperature')|float(99) < 55,
          (states('sensor.hours_since_last_vacuum')|float(0) > 48
            and is_state('binary_sensor.pool_season','on')),
          states('sensor.omnilogic_pool_chlorinator_average_salt_level')|float(9999) < 2700,
          states('sensor.smithy_hot_water_availability_2')|float(9999)   < 20
        ] %}
        {# ─── 2) Battery list and count (< 20%) ─── #}
        {% set battery_sensors = expand(
          'sensor.bedroom_back_1_battery',
          'sensor.back_2_battery',
          'sensor.back_3_battery',
          'sensor.bedroom_back_4_battery_0',
          'sensor.bedroom_back_5_battery_0',
          'sensor.side_left_battery_2',
          'sensor.side_right_battery_0',
          'sensor.dining_room_front_left_battery_0',
          'sensor.front_left_battery',
          'sensor.front_right_battery_0',
          'sensor.bedroom_right_battery_0',
          'sensor.hallway_1_battery',
          'sensor.motionblind_ebae_battery',
          'sensor.bedroom_left_battery_0',
          'sensor.living_room_side_left_1_battery_0',
          'sensor.living_room_front_left_battery_0',
          'sensor.living_room_side_left_2_battery_0',
          'sensor.living_room_side_right_1_battery_0',
          'sensor.living_room_side_right_2_battery_0',
          'sensor.living_room_front_right_battery',
          'sensor.attic_temp_sensor_battery',
          'sensor.front_door_battery',
          'sensor.kitchen_french_doors_battery',
          'sensor.living_room_french_doors_battery',
          'sensor.mudroom_entry_battery',
          'sensor.mudroom_garage_battery',
          'sensor.utility_room_temp_sensor_battery',
          'sensor.back_guest_bedroom_side_battery',
          'sensor.back_guest_bedroom_back_left_battery',
          'sensor.back_guest_bedroom_back_right_battery'
        ) %}
        {% set low_batt = battery_sensors
            | map(attribute='state') | map('float', 100) | select('lt', 20) | list %}
        {% set low_batt_count = low_batt | count %}
        {# ─── 3) Final count: sum of booleans + count of low batteries ─── #}
        {{ (rules | map('int') | sum) + low_batt_count }}
      icon: mdi:alert-circle

    - name: "Lights On Count"
      unique_id: count_of_lights
      state: >
        {% set lights = [
          'light.front_foyer_pendants',
          'light.gym_main_lights',
          'light.kitchen_island_pendants',
          'light.kitchen_main_lights',
          'light.kitchen_outer_wall',
          'light.kitchen_window_seat_sconce',
          'light.laundry_room_main_lights',
          'light.living_room_floor_lamp_1',
          'light.living_room_floor_lamp_2',
          'light.living_room_main_lights',
          'light.media_room_main_lights',
          'light.media_room_table_lamp',
          'light.office_floor_lamp',
          'light.office_main_lights',
          'light.upstairs_hallway_main_lights',
          'light.basement_hallway_main_lights',
          'light.dining_room_accent_lights',
          'light.dining_room_main_lights',
          'light.dining_room_table_lamps',
          'light.driveway_sconces',
          'light.front_porch_overhead_light',
          'light.master_bathroom_main_lights',
          'light.master_bathroom_vanity_lights',
          'light.master_bedroom_main_lights',
          'light.master_bedroom_sconces',
          'light.master_bedroom_closet_light',
          'light.patio_back_porch_lights',
          'light.eve_light_strip_a5a4',
          'switch.bedroom_floor_lamp_switch',
          'switch.transformer_zone_1',
          'switch.transformer_zone_2',
          'switch.transformer_zone_3',
          'switch.transformer_zone_1_2',
          'switch.transformer_zone_2_2',
          'switch.transformer_zone_3_2'
        ] %}
        {% set on_lights = lights | select('is_state', 'on') | list %}
        {% if on_lights | length == 0 %}
          All Off
        {% else %}
          {{ on_lights | length }}
        {% endif %}

    - name: "Hours Since Last Vacuum"
      unique_id: hours_since_last_vacuum
      unit_of_measurement: "hours"
      state: >
        {% if states('input_datetime.last_pool_vacuum') %}
          {{ ((as_timestamp(now()) - as_timestamp(states.input_datetime.last_pool_vacuum.state)) / 3600) | round(1) }}
        {% else %}
          unknown
        {% endif %}

    - name: "Living Room Favorites List"
      unique_id: living_room_favorites
      state: "Stored in attributes"
      attributes:
        favorites: >-
          {% set data = [
            {
              'title': 'Hotel Costes Top 50',
              'media_content_id': 'https://open.spotify.com/playlist/5jryH9aMgkcQruOslKX7Fc?si=32fc87b4459942fd'
            },
            {
              'title': 'Spotify Chill Hits',
              'media_content_id': 'https://open.spotify.com/playlist/37i9dQZF1DX4WYpdgoIcn6?si=1a312b90ce0d4c3f'
            },
            {
              'title': 'MSNBC',
              'media_content_id': 'x-sonosapi-hls:channel-linear%3a95bffee3-e903-ca28-6332-1b94f41a8962?sid=37&flags=8232&sn=5'
            },
            {
              'title': 'Spotify Top 50 Australia',
              'media_content_id': 'https://open.spotify.com/playlist/37i9dQZEVXbJPcfkRz0wJ0?si=a937cf6d25854469'
            },
            {
              'title': 'Spotify Chill Mix',
              'media_content_id': 'https://open.spotify.com/playlist/37i9dQZF1EVHGWrwldPRtj?si=22aa560ebee04a04'
            }
          ] %}
          {{ data }}

    - name: "Solcast Seven Day"
      unique_id: "solcast_seven_day"
      state: >
        {{
          states('sensor.solcast_pv_forecast_forecast_today') | float(0) +
          states('sensor.solcast_pv_forecast_forecast_tomorrow') | float(0) +
          states('sensor.solcast_pv_forecast_forecast_day_3') | float(0)
        }}
      unit_of_measurement: "kWh"
      attributes:
        detailedForecast: >
          {%
            set days = state_attr('sensor.solcast_pv_forecast_forecast_today', 'detailedForecast') +
            state_attr('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast') +
            state_attr('sensor.solcast_pv_forecast_forecast_day_3', 'detailedForecast') +
            state_attr('sensor.solcast_pv_forecast_forecast_day_4', 'detailedForecast') +
            state_attr('sensor.solcast_pv_forecast_forecast_day_5', 'detailedForecast') +
            state_attr('sensor.solcast_pv_forecast_forecast_day_6', 'detailedForecast') +
            state_attr('sensor.solcast_pv_forecast_forecast_day_7', 'detailedForecast')
          %}
          {% set ns = namespace(combined_list=[]) %}
          {% for interval in days %}
            {% set ns.combined_list = ns.combined_list + [
              {
                'period_start': interval['period_start'].isoformat(),
                'pv_estimate': interval['pv_estimate'],
                'pv_estimate10': interval['pv_estimate10'],
                'pv_estimate90': interval['pv_estimate90'],
              }
            ] %}
          {% endfor %}
          {{ ns.combined_list | to_json() }}
    
    # Calculate "Other" usage
    - name: "Home Other Usage"
      unique_id: home_other_usage
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      state: >
        {% set total = states('sensor.bayberry_home_usage') | float(0) %}
        {% set well  = states('sensor.well_pump_energy2') | float(0) %}
        {% set pool  = states('sensor.pool_pump_energy') | float(0) %}
        {% set water = states('sensor.smithy_energy_usage_2') | float(0) %}
        {% set ev    = states('sensor.wall_charger_energy') | float(0) %}
        {{ [ total - well - pool - water - ev, 0 ] | max | round(2) }}

- binary_sensor:
    - name: scene_show_morning
      state: >
        {% set now = now() %}
        {% set start = today_at('05:00') %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% if sunset %}
          {% set sunset_time = as_datetime(sunset) %}
          {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
          {{ now >= start and time_until_sunset > 1 and time_until_sunset < 19 }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_laundry
      state: >
        {% set now = now() %}
        {% set start = today_at('05:00') %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% if sunset %}
          {% set sunset_time = as_datetime(sunset) %}
          {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
          {{ now >= start and time_until_sunset > 1 and time_until_sunset < 19 }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_basement_evening
      state: >
        {% set now = now() %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% set end_time = today_at('23:00') %}
        {% if sunset %}
          {% set sunset_time = as_datetime(sunset) %}
          {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
          {{ is_state('binary_sensor.someone_home','on')
              and is_state('input_boolean.dinner_party','off')
              and ((time_until_sunset <= 1 and time_until_sunset >= 0) or (is_state('sun.sun', 'below_horizon') and now.hour >= 12))
              and now < end_time }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show__basement_entertaining
      state: >
        {% set now = now() %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% set end_time = today_at('23:00') %}
        {% if sunset %}
          {% set sunset_time = as_datetime(sunset) %}
          {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
          {{ is_state('binary_sensor.someone_home','on')
              and is_state('input_boolean.dinner_party','on')
              and ((time_until_sunset <= 1 and time_until_sunset >= 0) or is_state('sun.sun', 'below_horizon'))
              and now < end_time }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_welcome
      state: >
        {% set now = now() %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% if sunset %}
          {% set sunset_time = as_datetime(sunset) %}
          {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
          {% set lc = states.binary_sensor.someone_home.last_changed %}
          {{ is_state('binary_sensor.someone_home','on')
              and ((time_until_sunset <= 1 and time_until_sunset >= 0) or is_state('sun.sun', 'below_horizon'))
              and lc >= (now - timedelta(minutes=15)) }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_basement_cleaning
      unique_id: scene_show_basement_cleaning
      state: >
        {% set now = now() %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% if sunset %}
          {% set one_hr_before_sunset = as_datetime(sunset) - timedelta(hours=1) %}
          {{ is_state('sun.sun', 'above_horizon') and now < one_hr_before_sunset }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_outdoor_off
      unique_id: scene_show_outdoor_off
      state: >
        {% set now = now() %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% if sunset %}
          {% set sunset_time = as_datetime(sunset) %}
          {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
          {{ ((time_until_sunset <= 1 and time_until_sunset >= 0) or is_state('sun.sun', 'below_horizon')) and is_state('sensor.scene_outdoor_off', 'off') }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_outdoor_on
      unique_id: scene_show_outdoor_on
      state: >
        {% set now = now() %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% if sunset %}
          {% set sunset_time = as_datetime(sunset) %}
          {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
          {{ ((time_until_sunset <= 1 and time_until_sunset >= 0) or is_state('sun.sun', 'below_horizon')) and is_state('sensor.scene_outdoor_off', 'on') }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_emergency
      unique_id: scene_show_emergency
      state: >
        {% set now = now() %}
        {% set sunset = state_attr('sun.sun','next_setting') %}
        {% set end_time = today_at('05:00') %}
        {% if sunset %}
          {% set one_hr_before_sunset = as_datetime(sunset) - timedelta(hours=1) %}
          {{ ((is_state('sun.sun', 'below_horizon') and now < end_time) or (now >= one_hr_before_sunset)) and is_state('sensor.scene_good_night', 'on') }}
        {% else %} 
          false 
        {% endif %}

    - name: scene_show_nightlight_slot_1
      unique_id: scene_show_nightlight_slot_1
      state: >
        {% set now = now() %}
        {% set start_time = today_at('23:00') %}
        {% set end_time = today_at('05:00') %}
        {{ now >= start_time or now < end_time }}

    - name: scene_show_nightlight_slot_2
      unique_id: scene_show_nightlight_slot_2
      state: >
        {% set now = now() %}
          {% set sunset = state_attr('sun.sun','next_setting') %}
          {% set start_time = today_at('23:00') - timedelta(days=1) %}
          {% set end_time = today_at('05:00') %}
          {% if sunset %}
            {% set sunset_time = as_datetime(sunset) %}
            {% set time_until_sunset = (sunset_time - now).total_seconds() / 3600 %}
            {{ ((time_until_sunset <= 1 and time_until_sunset >= 0) or (is_state('sun.sun', 'below_horizon') and now >= start_time)) and now < end_time }}
          {% else %} 
            false 
          {% endif %}

- trigger:
    - trigger: event
      event_type: bubble_card_update_modules
  sensor:
    - name: "Bubble Card Modules"
      unique_id: bubble_card_modules
      state: "saved"
      icon: "mdi:puzzle"
      attributes:
        modules: "{{ trigger.event.data.modules }}"
        last_updated: "{{ trigger.event.data.last_updated }}"
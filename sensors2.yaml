- sensor:
    - name: "Notification Alert Counter"
      unique_id: notification_alert_counter
      state: >
        {# ─── 1) Boolean rules (each evaluates to True/False) ─── #}
        {% set rules = [
          is_state('binary_sensor.bayberry_grid_status', 'off'),
          is_state('binary_sensor.dryer_recently_completed', 'on'),
          is_state('binary_sensor.washer_recently_completed', 'on'),
          (is_state('sensor.bayberry_tempest_precipitation_type','rain')
            and is_state('binary_sensor.pool_cover_pump','off')),
          is_state('cover.garage_door_garage','open'),
          is_state('input_boolean.low_pool_water_level','on'),
          (states('sensor.roborock_s8_vacuum_error') not in ['none','unknown','unavailable'] and states('sensor.roborock_s8_vacuum_error') != ''),
          (is_state('binary_sensor.bayberry_grid_status','off')
            and states('sensor.bayberry_charge')|float(100) < 25),
          (states('sensor.nws_alerts_alerts') not in ['unknown','unavailable'] and states('sensor.nws_alerts_alerts')|int(0) > 0),
          states('sensor.front_load_washer_tub_clean_counter')|int(0) > 30,
          states('sensor.months_since_last_hot_water_flush')|float(0) > 5.9,
          states('input_number.upper_floors_hvac_filter_hours')|int(0) > 2000,
          states('input_number.lower_floors_hvac_filter_hours')|int(0) > 2000,
          states('sensor.utility_room_temp_sensor_temperature')|float(99) < 55,
          states('sensor.utility_room_temp_sensor_temperature')|float(0)  > 80,
          states('sensor.attic_temp_sensor_temperature')|float(0)  > 80,
          states('sensor.attic_temp_sensor_temperature')|float(99) < 55,
          (states('sensor.hours_since_last_vacuum')|float(0) > 48
            and is_state('binary_sensor.pool_season','on')),
          states('sensor.omnilogic_pool_chlorinator_average_salt_level')|float(9999) < 2700,
          states('sensor.smithy_hot_water_availability_2')|float(9999)   < 20
        ] %}
        {# ─── 2) Battery list and count (< 20%) ─── #}
        {% set battery_sensors = expand(
          'sensor.bedroom_back_1_battery',
          'sensor.back_2_battery',
          'sensor.back_3_battery',
          'sensor.bedroom_back_4_battery_0',
          'sensor.bedroom_back_5_battery_0',
          'sensor.side_left_battery_2',
          'sensor.side_right_battery_0',
          'sensor.dining_room_front_left_battery_0',
          'sensor.front_left_battery',
          'sensor.front_right_battery_0',
          'sensor.bedroom_right_battery_0',
          'sensor.hallway_1_battery',
          'sensor.hallway_2_battery_0',
          'sensor.bedroom_left_battery_0',
          'sensor.living_room_side_left_1_battery_0',
          'sensor.living_room_front_left_battery_0',
          'sensor.living_room_side_left_2_battery_0',
          'sensor.living_room_side_right_1_battery_0',
          'sensor.living_room_side_right_2_battery_0',
          'sensor.living_room_front_right_battery',
          'sensor.attic_temp_sensor_battery',
          'sensor.front_door_battery',
          'sensor.kitchen_french_doors_battery',
          'sensor.living_room_french_doors_battery',
          'sensor.mudroom_entry_battery',
          'sensor.mudroom_garage_battery',
          'sensor.utility_room_temp_sensor_battery',
          'sensor.back_guest_bedroom_side_battery',
          'sensor.back_guest_bedroom_back_left_battery',
          'sensor.back_guest_bedroom_back_right_battery'
        ) %}
        {% set low_batt = battery_sensors
            | map(attribute='state') | map('float', 100) | select('lt', 20) | list %}
        {% set low_batt_count = low_batt | count %}
        {# ─── 3) Final count: sum of booleans + count of low batteries ─── #}
        {{ (rules | map('int') | sum) + low_batt_count }}
      icon: mdi:alert-circle

    - name: "Lights On Count"
      unique_id: count_of_lights
      state: >
        {% set lights = [
          'light.front_foyer_pendants',
          'light.gym_main_lights',
          'light.kitchen_island_pendants',
          'light.kitchen_main_lights',
          'light.kitchen_outer_wall',
          'light.kitchen_window_seat_sconce',
          'light.laundry_room_main_lights',
          'light.living_room_floor_lamp_1',
          'light.living_room_floor_lamp_2',
          'light.living_room_main_lights',
          'light.media_room_main_lights',
          'light.media_room_table_lamp',
          'light.office_floor_lamp',
          'light.office_main_lights',
          'light.upstairs_hallway_main_lights',
          'light.basement_hallway_main_lights',
          'light.dining_room_accent_lights',
          'light.dining_room_main_lights',
          'light.dining_room_table_lamps',
          'light.driveway_sconces',
          'light.front_porch_overhead_light',
          'light.master_bathroom_main_lights',
          'light.master_bathroom_vanity_lights',
          'light.master_bedroom_main_lights',
          'light.master_bedroom_sconces',
          'light.master_bedroom_closet_light',
          'light.patio_back_porch_lights',
          'light.eve_light_strip_a5a4',
          'switch.bedroom_floor_lamp_switch',
          'switch.transformer_zone_1',
          'switch.transformer_zone_2',
          'switch.transformer_zone_3',
          'switch.transformer_zone_1_2',
          'switch.transformer_zone_2_2',
          'switch.transformer_zone_3_2'
        ] %}
        {% set on_lights = lights | select('is_state', 'on') | list %}
        {% if on_lights | length == 0 %}
          All Off
        {% else %}
          {{ on_lights | length }}
        {% endif %}

    - name: "Hours Since Last Vacuum"
      unique_id: hours_since_last_vacuum
      unit_of_measurement: "hours"
      state: >
        {% if states('input_datetime.last_pool_vacuum') %}
          {{ ((as_timestamp(now()) - as_timestamp(states.input_datetime.last_pool_vacuum.state)) / 3600) | round(1) }}
        {% else %}
          unknown
        {% endif %}

    # - name: "Solcast Seven Day"
    #   unique_id: "solcast_seven_day"
    #   state: >
    #     {{
    #       states('sensor.solcast_pv_forecast_forecast_today') | float(0) +
    #       states('sensor.solcast_pv_forecast_forecast_tomorrow') | float(0) +
    #       states('sensor.solcast_pv_forecast_forecast_day_3') | float(0) +
    #       states('sensor.solcast_pv_forecast_forecast_day_4') | float(0) +
    #       states('sensor.solcast_pv_forecast_forecast_day_5') | float(0) +
    #       states('sensor.solcast_pv_forecast_forecast_day_6') | float(0) +
    #       states('sensor.solcast_pv_forecast_forecast_day_7') | float(0)
    #     }}
    #   unit_of_measurement: "kWh"
    #   attributes:
    #     detailedForecast: >
    #       {%
    #         set days = state_attr('sensor.solcast_pv_forecast_forecast_today', 'detailedForecast') +
    #         state_attr('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast') +
    #         state_attr('sensor.solcast_pv_forecast_forecast_day_3', 'detailedForecast') +
    #         state_attr('sensor.solcast_pv_forecast_forecast_day_4', 'detailedForecast') +
    #         state_attr('sensor.solcast_pv_forecast_forecast_day_5', 'detailedForecast') +
    #         state_attr('sensor.solcast_pv_forecast_forecast_day_6', 'detailedForecast') +
    #         state_attr('sensor.solcast_pv_forecast_forecast_day_7', 'detailedForecast')
    #       %}
    #       {% set ns = namespace(combined_list=[]) %}
    #       {% for interval in days %}
    #         {% set ns.combined_list = ns.combined_list + [
    #           {
    #             'period_start': interval['period_start'].isoformat(),
    #             'pv_estimate': interval['pv_estimate'],
    #             'pv_estimate10': interval['pv_estimate10'],
    #             'pv_estimate90': interval['pv_estimate90'],
    #           }
    #         ] %}
    #       {% endfor %}
    #       {{ ns.combined_list | to_json() }}
    
    # Calculate "Other" usage
    # - name: "Home Other Usage"
    #   unique_id: home_other_usage
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing
    #   icon: mdi:home-lightning-bolt
    #   state: >
    #     {% set total = states('sensor.bayberry_load_import') | float(0) %}
    #     {% set well  = states('sensor.well_pump_energy2') | float(0) %}
    #     {% set pool  = states('sensor.pool_pump_energy') | float(0) if states('sensor.pool_pump_energy') not in ['unavailable', 'unknown'] else 0 %}
    #     {% set water = states('sensor.hot_water_heater') | float(0) if states('sensor.hot_water_heater') not in ['unavailable', 'unknown'] else 0 %}
    #     {% set ev    = states('sensor.wall_charger_energy') | float(0) %}

    #     {% set other = total - well - pool - water - ev %}
    #     {{ [other, 0] | max | round(2) }}

- trigger:
    - trigger: event
      event_type: bubble_card_update_modules
  sensor:
    - name: "Bubble Card Modules"
      unique_id: bubble_card_modules
      state: "saved"
      icon: "mdi:puzzle"
      attributes:
        modules: "{{ trigger.event.data.modules }}"
        last_updated: "{{ trigger.event.data.last_updated }}"
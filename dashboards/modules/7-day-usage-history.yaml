# =============================================================================
# Energy Usage Chart - Fixed
# =============================================================================
#
# Changes:
#   - Uses corrected sensor.home_other_usage (with total_increasing state_class)
#   - Pool pump uses transform to handle unavailable state
#   - Consistent use of 'diff' for all cumulative energy sensors
#
# Note: If hot water sensor resets or has gaps, you may need 'delta' instead
# of 'diff' for that one sensor (delta sums positive changes, ignoring resets)
# =============================================================================

type: custom:apexcharts-card
header:
  show: true
  show_states: true
graph_span: 3d
span:
  start: day
  offset: "-6d"
apex_config:
  chart:
    type: bar
    stacked: true
    height: 300px
  title:
    align: left
    style:
      fontSize: '18px'
      fontWeight: 'bold'
  dataLabels:
    enabled: true
  xaxis:
    type: datetime
    labels:
      format: ddd MMM dd
  yaxis:
    decimals: 1
    labels:
      formatter: |
        EVAL:function(value) {
          return value.toFixed(1) + ' kWh';
        }
series:
  # ===========================================
  # DAILY BARS (shown in chart)
  # ===========================================
  - entity: sensor.home_other_usage
    name: Other
    type: column
    color: "#4C4F69"
    group_by:
      func: diff
      duration: 1d
    transform: "return Math.max(x, 0);"
    show:
      legend_value: false
      in_header: false
  - entity: sensor.smithy_energy_usage_2
    name: Hot Water
    type: column
    color: "#5D617A"
    group_by:
      func: delta
      duration: 1d
    show:
      legend_value: false
      in_header: false
  - entity: sensor.wall_charger_energy
    name: EV Charger
    type: column
    color: "#6E728A"
    group_by:
      func: diff
      duration: 1d
    show:
      legend_value: false
      in_header: false
  - entity: sensor.well_pump_energy2
    name: Well Pump
    type: column
    color: "#80849A"
    group_by:
      func: diff
      duration: 1d
    show:
      legend_value: false
      in_header: false
  # - entity: sensor.pool_pump_energy
  #   name: Pool Pump
  #   type: column
  #   color: "#9498AC"
  #   group_by:
  #     func: diff
  #     duration: 1d
  #   transform: "return (x == null || isNaN(x)) ? 0 : Math.max(x, 0);"
  #   show:
  #     legend_value: false
  #     in_header: false
  # ===========================================
  # 7-DAY TOTALS (shown in header only)
  # ===========================================
  - entity: sensor.home_other_usage
    name: Other
    type: column
    color: "#4C4F69"
    group_by:
      func: diff
      duration: 3d
    transform: "return Math.max(x, 0);"
    show:
      legend_value: false
      in_header: true
      in_chart: false
  - entity: sensor.smithy_energy_usage_2
    name: Hot Water
    type: column
    color: "#5D617A"
    group_by:
      func: delta
      duration: 3d
    show:
      legend_value: false
      in_header: true
      in_chart: false
  - entity: sensor.wall_charger_energy
    name: EV Charger
    type: column
    color: "#6E728A"
    group_by:
      func: diff
      duration: 3d
    show:
      legend_value: false
      in_header: true
      in_chart: false
  - entity: sensor.well_pump_energy2
    name: Well Pump
    type: column
    color: "#80849A"
    group_by:
      func: diff
      duration: 3d
    show:
      legend_value: false
      in_header: true
      in_chart: false
  # - entity: sensor.pool_pump_energy
  #   name: Pool Pump
  #   type: column
  #   color: "#9498AC"
  #   group_by:
  #     func: diff
  #     duration: 7d
  #   transform: "return (x == null || isNaN(x)) ? 0 : Math.max(x, 0);"
  #   show:
  #     legend_value: false
  #     in_header: true
  #     in_chart: false